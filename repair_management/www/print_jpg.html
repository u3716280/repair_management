{% extends "templates/web.html" %}

{% block title %}{{ doc_name }}{% endblock %}

{% block page_content %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    body {
        background-color: #525252;
    }
    .print-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
    }
    .container {
        max-width: 1200px;
        width: 100%;
    }
    .controls {
        text-align: center;
        margin-bottom: 20px;
    }
    .btn {
        background: #2490ef;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 0 5px;
    }
    .btn:hover {
        background: #1a7bc7;
    }
    .btn-line {
        background: #06C755;
    }
    .btn-line:hover {
        background: #05B34A;
    }
    img {
        width: 100%;
        height: auto;
        display: block;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        background: white;
    }
</style>

<div class="print-container">
    <div class="container">
        <div class="controls">
            <button class="btn" onclick="downloadImage()">Download JPG</button>
            <button class="btn btn-line" onclick="shareToLine()">Share to LINE</button>
            <button class="btn" onclick="window.print()">Print</button>
            <button class="btn" onclick="window.close()">Close</button>
        </div>
        <img id="mainImage" src="data:image/jpeg;base64,{{ img_base64 }}" alt="{{ doc_name }}">
    </div>
</div>

<script>
    function downloadImage() {
        const link = document.createElement('a');
        link.href = document.getElementById('mainImage').src;
        link.download = '{{ doc_name }}'.replace(/ /g, '-').replace(/\//g, '-') + '.jpg';
        link.click();
    }

    async function shareToLine() {
        const img = document.getElementById('mainImage');
        const filename = '{{ doc_name }}'.replace(/ /g, '-').replace(/\//g, '-');

        try {
            // Convert base64 to blob
            const response = await fetch(img.src);
            const blob = await response.blob();
            
            // Try Web Share API first (works on mobile)
            if (navigator.share && navigator.canShare) {
                const file = new File([blob], `${filename}.jpg`, { type: 'image/jpeg' });
                const shareData = {
                    files: [file],
                    title: filename
                };

                if (navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                    return;
                }
            }

            // Fallback: Try LINE URL scheme (mobile)
            if (/Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                // Download the image first
                downloadImage();
                
                // Show instructions
                alert('Image downloaded! Please:\n1. Open LINE app\n2. Select a chat\n3. Tap + button\n4. Choose Photo\n5. Select the downloaded image');
            } else {
                // Desktop: Download and show instructions
                downloadImage();
                alert('Image downloaded! To share via LINE:\n1. Open LINE on your phone\n2. Select a chat or group\n3. Tap the + button\n4. Choose "Photo"\n5. Select the downloaded image');
            }
        } catch (err) {
            console.error('Share failed:', err);
            // Fallback to download
            downloadImage();
            alert('Please share the downloaded image manually via LINE');
        }
    }
</script>
{% endblock %}
